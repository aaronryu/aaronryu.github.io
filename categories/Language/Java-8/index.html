<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Category: Java 8 - Crucian Carp</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Crucian Carp"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Crucian Carp"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Cool heads but warm hearts"><meta property="og:type" content="blog"><meta property="og:title" content="Crucian Carp"><meta property="og:url" content="https://aaronryu.github.io/"><meta property="og:site_name" content="Crucian Carp"><meta property="og:description" content="Cool heads but warm hearts"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://aaronryu.github.io/img/og_image.png"><meta property="article:author" content="Aaron Ryu"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://aaronryu.github.io"},"headline":"Crucian Carp","image":["https://aaronryu.github.io/img/og_image.png"],"author":{"@type":"Person","name":"Aaron Ryu"},"description":"Cool heads but warm hearts"}</script><link rel="alternate" href="/atom.xml" title="Crucian Carp" type="application/atom+xml"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/solarized-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-134840627-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-134840627-1');</script><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Crucian Carp</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-9-tablet is-9-desktop is-9-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/categories">Categories</a></li><li><a href="/categories/Language/">Language</a></li><li class="is-active"><a href="#" aria-current="page">Java 8</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><div>2021-01-31</div></span><span class="level-item"><a class="link-muted" href="/categories/Language/">Language</a><span> / </span><a class="link-muted" href="/categories/Language/Java-8/">Java 8</a></span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/31/problems-when-using-parallel-stream-with-hash-map/">[Troubleshooting] ParallelStream 과 HashMap 함께 사용시 이슈</a></h1><div class="content"><h1 id="Monolithic-Architecture-gt-MSA-전환으로-인한-성능-저하"><a href="#Monolithic-Architecture-gt-MSA-전환으로-인한-성능-저하" class="headerlink" title="Monolithic Architecture -&gt; MSA 전환으로 인한 성능 저하"></a>Monolithic Architecture -&gt; MSA 전환으로 인한 성능 저하</h1><p>최근 Monolithic Architecture 구조의 레가시 시스템을 MSA 구조로 바꾸는 리플랫폼을 진행하였었습니다. 기존 레가시 시스템은 여러 서브도메인에 해당하는 테이블들이 단일 쿼리에 수많은 Join 으로 연결되어있어서 성능이 매우 좋았지만, 유지보수성에 있어서는 최악의 구조를 갖고있었습니다. 예약, 결제, 정산, 상품 등 각 서브도메인들을 서비스들로 나누어서 API 호출을 통해 요청을 처리하도록 만들고보니 유지보수성은 올라갔지만 SQL Join 을 사용하던 것을 API 로 바꾸다보니 네트워크 시간에 의해 성능이 저하되어 이 해결이 또 다른 리플랫폼의 챌린지 포인트였습니다.</p>
<h1 id="Java-8-Stream-gt-ParallelStream-을-통한-성능-개선"><a href="#Java-8-Stream-gt-ParallelStream-을-통한-성능-개선" class="headerlink" title="Java 8 Stream -&gt; ParallelStream 을 통한 성능 개선"></a>Java 8 Stream -&gt; ParallelStream 을 통한 성능 개선</h1><p>SQL Join 을 API 호출 및 Java 8 로직으로 변환하면서 stream 을 곳곳에서 자주 사용하였었는데, 단순하게 이걸 parallelStream 으로 바꾸었더니 몇초 걸렸던 느린 성능이 1초 이내 ms 단위로 처리되었기 때문에 남용하기 시작하였습니다. 그리고 그 무게는 이후 굉장히 무거운 몇몇의 이슈로 다가오게됩니다.</p>
<h1 id="No-Silver-Bullet-Java-8-ParallelStream"><a href="#No-Silver-Bullet-Java-8-ParallelStream" class="headerlink" title="No Silver Bullet - Java 8 ParallelStream"></a>No Silver Bullet - Java 8 ParallelStream</h1><h2 id="Java-8-ParallelStream"><a href="#Java-8-ParallelStream" class="headerlink" title="Java 8 ParallelStream"></a>Java 8 ParallelStream</h2><p>ParallelStream 는 Java 8 에서 도입된 <strong>멀티스레드 프로그래밍</strong>을 매우 쉽게 사용할수 있게 해주는 도구입니다. 학부때도 <strong>멀티스레드</strong>가 제일 복잡하고 힘들었었는데, 이걸 단 하나의 코드로 쉽게 사용하게 해준다니 스레드 관리의 복잡함에 혀를 내둘렀던 저에겐 굉장히 매력적으로 다가왔습니다. 또한 타 웹페이지에서 고전적 for-each, stream, parallelStream 성능 비교를 보면 당연하겠지만 말도 안되게 빠른 성능을 제공해주는걸 알 수 있습니다.</p>
<p><strong>기존 ExecutorService</strong></p>
<ul>
<li>스레드 풀 내 스레드 개수를 정의하고<br>(ExecutorService executor = Executors.newFixedThreadPool(5))</li>
<li>분할하기 원하는 작업을 위 executor 에 하나씩 지정(execute())하면 적합한 스레드를 자동으로 할당하여 수행해줍니다.</li>
<li>그리고 사용한 스레드 풀은 닫습니다 (shutdown())</li>
</ul>
<p><strong>신규 ForkJoinPool</strong></p>
<ul>
<li>JVM 내 공유되는 ForkJoinPool 스레드 풀 내 스레드 개수를 <strong>“프로세서 개수 - 1”</strong> 로 정의합니다.<br>(예, 4 코어 = 3 스레드, 병렬성 향상을 위해 직접 스레드 개수 설정도 가능합니다.)<br>(예, -Djava.util.concurrent.ForkJoinPool.common.parallelism = 6)</li>
<li>ForkJoinPool 는 <strong>Queue 가 추가된</strong> 기존 ExecutorService 의 구현체로 </li>
<li>스레드 각각을 (1) Fork 를 통해 Task 를 분담하고 (2) Join 을 통해 결과를 합치는 과정을 반복해서 동시성을 제공합니다.</li>
<li><strong>ParallelStream 은 이 신규 ForkJoinPool 를 통해 동작됩니다.</strong></li>
</ul>
<p><strong>ParallelStream</strong> 동작의 개요를 알았으니, 이걸 사용하면서 맞닥트린 이슈와 그 원인을 살펴보도록 하겠습니다.</p>
<h2 id="HashMap-의-put-get-은-not-thread-safe"><a href="#HashMap-의-put-get-은-not-thread-safe" class="headerlink" title="HashMap 의 put/get 은 not-thread-safe"></a>HashMap 의 put/get 은 not-thread-safe</h2><p>ParallelStream 을 통해 서비스 성능 개선을 이루고 많은 시간이 지나서 갑자기 서버 인스턴스 CPU 가 75% 를 넘어서서 오랜시간동안 계속 내려오지 않는 온콜이 발생하였었습니다. 점유율이 오랜시간동안 75% 에서 내려오지 않자 <strong>무한 루프에 진입한것으로 보여 쓰레드 덤프를 분석해보니 parallelStream 에서 할당된 스레드에서 block 인채 멈춰있는걸 발견하였습니다.</strong></p>
<p>문제의 로직은 ParallelStream 을 통해 not-thread-safe 인 HashMap 에 동시적으로 put 처리한 부분이었습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Integer, Boolean&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">sampleList.parallelStream().forEach(each -&gt;</span><br><span class="line">  result.put(each.getId(), isSample)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>간단하게 생각하면 List 가 아닌 Map 이기때문에 주입되는 순서도 상관없고, 값이 잘 들어가기만 하면 본 코드는 문제없어 보입니다. <strong>하지만 이는 HashMap 의 구조와 Rehashing 을 전혀 고려하지 않은 생각입니다.</strong> HashMap 은 새로운 키, 값을 주입(put)시 아래의 과정을 거쳐 이뤄집니다.</p>
<ul>
<li>(1) 새로 추가하는 키에 대한 Hash 를 생성하고</li>
<li>(2) Hash 테이블 내 해당 Hash 인덱스에 포인터를 통해 해당 키를 적재하게 됩니다.</li>
<li>(3) 만약 Hash 인덱스에 키들이 일정 개수를 넘으면 Rehashing 을 통해<br>Hash 인덱스를 나누어 키들을 분리 적재하게 됩니다.</li>
</ul>
<h2 id="Race-Condition"><a href="#Race-Condition" class="headerlink" title="Race Condition"></a>Race Condition</h2><p>위 과정 중에 (2)번과 (3)번은 키들 간에 포인터 변경 부분이 thread-safe 하지않아서, 다수의 스레드가 한번에 포인터를 변경하려 하면 문제가 발생할 수 있습니다. 만약 스레드 1과 스레드 2가 각자 다른 키를 같은 Hash 인덱스에 추가하고 두 스레드에서 동시에 rehashing 이 일어난다면, <strong>두 스레드가 키들에 대한 포인터들을 재설정하는 과정에서 서로 꼬여 포인트간 사이클이 발생하게 됩니다.</strong> HashMap 특성상 키를 넣거나(put) 조회할때(get) 특정 Hash 에 적재된 키들을 for 문을 통해서 순회하기 때문에 위 사이클은 무한루프에 빠져버립니다. 발생한 온콜의 CPU 상위 점유의 원인인 셈입니다. 키들에 대한 포인터들을 다수의 스레드가 변경하면서 사이클을 만들기도하지만 <strong>포인터가 유실되어 키를 10000 번 put 주입하였는데 실제 HashMap 에 저장된 키는 10000 개가 아닌 황당한 경우도 발생합니다.</strong></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p><strong>Java ParallelStream 을 활용</strong>하여 <strong>외부 HashMap 애 put 을 수행</strong>하게 되면, ForkJoinPool 를 통해 다수의 스레드들이 각자 put 을 수행하게 됩니다. 이때 HashMap 의 put 은 <strong>(1) hash 값 계산</strong>과 <strong>(2) 값들간의 포인터 변경</strong>을 통해 수행되는데, <strong>(2) 포인터 변경부분이 thread-safe 하지 않기 때문에 각 스레드간 포인터 조작시 Race Condition 이 발생할 수 있습니다.</strong> </p>
<ul>
<li><strong>키들 간 포인터가 서로를 가리켜서</strong> get, put 수행시에 무한루프에 걸리는 경우</li>
<li><strong>키들 간 포인터가 유실되면서</strong> 실제 10000 번 put 수행하더라도, 실제 HashMap 사이즈가 10000 이 안되는 경우</li>
</ul>
<p>온콜 해결을 위해서 서비스 전체 로직에서 ParallelStream 이 사용되는 부분을 모두 걷어내었었습니다. 해결을 위해 ConcurrentHashMap 을 사용해도되지만 해당 로직에서 일반적으로 ParallelStream 의 루프 횟수가 10000 건을 넘어서는 유즈케이스도 있었기 때문에 스레드를 잘 활용한다고 하여도 CPU 와 메모리에 무리를 줄 수 있었기 때문에 로직을 효율적으로 변경하는것으로 해결하였습니다.</p>
<hr>
<p>참조</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.naver.com/tmondev/220945933678">https://blog.naver.com/tmondev/220945933678</a></li>
<li><a target="_blank" rel="noopener" href="http://www.h-online.com/developer/features/The-fork-join-framework-in-Java-7-1762357.html">http://www.h-online.com/developer/features/The-fork-join-framework-in-Java-7-1762357.html</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@itugs/custom-forkjoinpool-in-java-8-parallel-stream-9090882472db">https://medium.com/@itugs/custom-forkjoinpool-in-java-8-parallel-stream-9090882472db</a></li>
</ol>
</div></article></div></div><div class="column column-left is-3-tablet is-3-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">Categories</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Deployment/"><span class="level-start"><span class="level-item">Deployment</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/Deployment/Docker/"><span class="level-start"><span class="level-item">Docker</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Design-Pattern/"><span class="level-start"><span class="level-item">Design Pattern</span></span><span class="level-end"><span class="level-item tag">6</span></span></a><ul><li><a class="level is-mobile" href="/categories/Design-Pattern/Adapter-Decorator/"><span class="level-start"><span class="level-item">Adapter, Decorator</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-Pattern/Factory/"><span class="level-start"><span class="level-item">Factory</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-Pattern/Observer/"><span class="level-start"><span class="level-item">Observer</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Design-Pattern/Singleton/"><span class="level-start"><span class="level-item">Singleton</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Language/"><span class="level-start"><span class="level-item">Language</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/Language/Functional-Programming/"><span class="level-start"><span class="level-item">Functional Programming</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Language/Java-8/"><span class="level-start"><span class="level-item">Java 8</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Language/Javascript/"><span class="level-start"><span class="level-item">Javascript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Language/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Language/Swift-4-iOS/"><span class="level-start"><span class="level-item">Swift 4+ / iOS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Programming/"><span class="level-start"><span class="level-item">Programming</span></span><span class="level-end"><span class="level-item tag">3</span></span></a><ul><li><a class="level is-mobile" href="/categories/Programming/Develop/"><span class="level-start"><span class="level-item">Develop</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/Programming/Licenses/"><span class="level-start"><span class="level-item">Licenses</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/Workplace/"><span class="level-start"><span class="level-item">Workplace</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="Aaron Ryu"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Aaron Ryu</p><p class="is-size-6 is-block">Software Engineer</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">17</p></a></div></div></nav><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/aaronryu"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Gitlab" href="https://gitlab.com/aaronryu"><i class="fab fa-gitlab"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Crucian Carp</a><p class="is-size-7"><span>&copy; 2021 Aaron Ryu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: false,
                    fold: ''
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>