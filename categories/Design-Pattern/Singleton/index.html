<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Category: Singleton - Crucian Carp</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="naver-site-verification" content="2316a6af47a7b653c7f6af966d7c718fb98027ed">

<link rel="canonical" href="https://aaronryu.github.io/categories/design-pattern/singleton/">


    <meta name="description" content="Cool heads but warm hearts">
<meta property="og:type" content="website">
<meta property="og:title" content="Crucian Carp">
<meta property="og:url" content="https://aaronryu.github.io/categories/Design-Pattern/Singleton/index.html">
<meta property="og:site_name" content="Crucian Carp">
<meta property="og:description" content="Cool heads but warm hearts">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Crucian Carp">
<meta name="twitter:description" content="Cool heads but warm hearts">



<link rel="alternative" href="atom.xml" title="Crucian Carp" type="application/atom+xml">



<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/androidstudio.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-134840627-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134840627-1');
</script>


    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                Crucian Carp
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="/about">About</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="Search" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-9-tablet is-9-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/categories">Categories</a></li>
            
            <li><a href="/categories/Design-Pattern/">Design Pattern</a></li>
            
            <li class="is-active"><a href="#" aria-current="page">Singleton</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <!-- <time class="level-item has-text-grey" datetime="2019-03-02T12:15:18.000Z">2019-03-02</time> -->
                <div class="level-item has-text-grey">2019-03-02</div>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Design-Pattern/">Design Pattern</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/Design-Pattern/Singleton/">Singleton</a>
                </div>
                
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/03/02/singleton-pattern/">6. 싱글턴 패턴</a>
            
        </h1>
        <div class="content">
            <p>디자인 패턴은 무조건 아래 두 글을 선행해야합니다. 짧으니 간단히 읽고 오시면 이해가 쉽습니다.</p>
<ul>
<li><a href="https://aaronryu.github.io/2018/12/30/a-introduction-to-design-patterns/">1. 디자인 패턴에 앞서</a></li>
<li><a href="https://aaronryu.github.io/2019/02/21/two-principles-of-design-patterns/">2. 디자인 패턴의 제 1, 2 원칙</a></li>
</ul>
<p>설명에 사용할 코드는 Java-like Pseudo Code 입니다.</p>
<hr>
<h1 id="‘정적-변수’-및-‘정적-메서드’"><a href="#‘정적-변수’-및-‘정적-메서드’" class="headerlink" title="‘정적 변수’ 및 ‘정적 메서드’"></a>‘정적 변수’ 및 ‘정적 메서드’</h1><p>코드를 작성하다보면 <strong>변수</strong>나 <strong>메서드</strong>를 <strong>단 하나만 생성하여 모든 곳에서 공유</strong>하여 사용할 때가 있습니다. <strong>정적 변수</strong>와 <strong>정적 메서드</strong>에 해당하는 개념입니다. Java 와 같이 객체지향 프로그램에서는 변수, 메서드 모두 클래스 내 존재해야하는 제약사항 때문에 공유하려는 <strong>전역 변수, 메서드</strong>를 클래스에 담아서 공유해야합니다. 재미있는 점은 <strong>정적 클래스</strong>라는 개념은 없기 때문에 클래스 안의 <strong>정적 변수나 메서드는 따로 객체 초기화 할 필요없이 바로 접근이 가능함</strong>과 동시에 원한다면 <strong>이 클래스를 객체로 초기화해서도 사용가능</strong>하다는 것입니다. 객체 초기화 없이 해당 클래스의 정적 변수와 정적 메서드를 사용한다니 이게 <strong>어떻게</strong> 가능한걸까요?</p>
<h2 id="Java-JVM-메모리"><a href="#Java-JVM-메모리" class="headerlink" title="Java, JVM 메모리"></a>Java, JVM 메모리</h2><p>Java 는 JVM 위에서 프로그램을 동작시키는데요. JVM 의 M, Machine 이 뜻하는대로 작은 OS 라고 보시면 됩니다. JVM 에서 돌리는 모든 프로그램의 자원을 JVM 이 관리합니다. 이런 이유로 Java 에 대한 이해는 JVM 메모리 관리에 대한 이해와 1:1의 관계에 놓여있습니다. 싱글턴 패턴을 배우기에 앞서 정적 변수, 메서드를 이해하기 위해 클래스, 변수, 메서드가 메모리에 어떤 JVM 메모리 영역에 할당이 되고 어떻게 정리가 되는지 간단하게 살펴보겠습니다. JVM 메모리 영역은 다음 세 영역으로 나뉩니다.</p>
<ul>
<li><strong>변하지 않는 값</strong>을 담는 <strong>Static 영역</strong> (이를 칭하는 용어는 아래 총 3가지가 있습니다)<ul>
<li><strong>변하지 않는 값</strong>을 담는다는 의미에서 <strong>Static 영역</strong>이라 부르기도 하고</li>
<li>객체화 되기 전 <strong>Class 그 자체</strong>를 담는다는 의미에서 <strong>Class 영역</strong>이라 부르기도 하고 (Class Loading)</li>
<li>객체화 되기 전 <strong>Class 의 함수</strong>를 담는다는 의미에서 <strong>Method 영역</strong>이라 부르기도 합니다.</li>
</ul>
</li>
<li><strong>변하는 값</strong>을 담는 <strong>Heap 영역</strong>과 <strong>Stack 영역</strong>으로 나뉩니다.<ul>
<li><strong>Stack 영역</strong>: 함수 내 ‘파라미터’나 ‘로컬변수’와 같이 그 함수 블록 내에만 생존하는 변수들을 저장</li>
<li><strong>Heap 영역</strong>: 객체들을 저장</li>
</ul>
</li>
</ul>
<p>객체 생성의 가장 근간이 되는 <strong>Class 는</strong> 바이트코드 형태로 <strong>Static 영역에 적재</strong>됩니다. 그 Class 를 객체화할때마다 그 <strong>객체와 객체의 변수, 메서드는</strong> 위 클래스 바이트코드를 참조하여 생성된 뒤에 <strong>Heap 영역에 적재</strong>됩니다. <strong>정적 변수, 메서드</strong>는 객체없이 Class 에 존재하는것이므로 <strong>Static 영역</strong>에 저장되겠군요. Static 영역에 Class 적재 및 객체 생성을 담당하는 것을 <strong>Classloader(클래스로더)</strong>라고 부르며 이 로더는 커스텀하게 바꾸지 않았다면 일반적으로 JVM 위에 하나만 존재합니다. 만약 두 개의 클래스로더가 있다면 같은 정적 변수라 할지라도 각자 다른 Static 영역에 적재됩니다. <strong>정적 변수, 메서드</strong>와 <strong>일반 객체의 변수, 메서드</strong>는 적재된 영역이 다르기 때문에 <strong>서로 참조하지 못하는 특징</strong>을 갖습니다.</p>
<h1 id="싱글턴-패턴"><a href="#싱글턴-패턴" class="headerlink" title="싱글턴 패턴"></a>싱글턴 패턴</h1><h2 id="정적-변수-메소드"><a href="#정적-변수-메소드" class="headerlink" title="정적 변수, 메소드"></a>정적 변수, 메소드</h2><p>정적 변수, 메서드는 ‘클래스로더’ 내 단 하나만 존재하는 <strong>유일무이한 “클래스”</strong>의 변수, 메서드입니다.<br>(클래스로더는 한 프로그램에 다수 개일 수 있습니다.)</p>
<ul>
<li><strong>Static 영역</strong>에 생성되는 <strong>클래스 변수, 메서드</strong>입니다.</li>
<li>프로그램의 시작과 동시에 클래스로더 에 의해 바이트코드형태로 <strong>Static 영역</strong> 메모리에 바로 적재됩니다.</li>
</ul>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span> </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// * Public: Can be initialized from outer</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Caculator</span><span class="hljs-params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="hljs-comment">// * Static: sum(a, b)</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">sum</span><span class="hljs-params">(Integer a, Integer a)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> a + b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="싱글턴-변수-메소드"><a href="#싱글턴-변수-메소드" class="headerlink" title="싱글턴 변수, 메소드"></a>싱글턴 변수, 메소드</h2><p>싱글턴 패턴의 정의는 ‘클래스로더’ 내 단 하나만 존재하는 <strong>유일무이한 “객체”</strong>의 변수, 메서드입니다.<br>(클래스로더는 한 프로그램에 다수 개일 수 있습니다.)</p>
<ul>
<li><strong>Heap 영역</strong>에 생성되는 <strong>객체 변수, 메서드</strong>입니다.</li>
<li>프로그램 실행 도중 필요한 그 시점에 객체로 <strong>Heap 영역</strong>에 적재됩니다. 그리곤 오랜기간 사용되지 않는다면 GC 됩니다.<br>(필요한 시점에 객체 생성하는것을 <strong>Lazy Loading</strong> 이라고 합니다. 싱글턴 패턴의 존재 의의기도 합니다.)</li>
</ul>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span> </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// * Priavte: Cannot be initialized from outer</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Caculator</span><span class="hljs-params">()</span> </span>&#123;&#125;</span><br><span class="line">  <span class="hljs-comment">// * Non-Static: sum(a, b)</span></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">sum</span><span class="hljs-params">(Integer a, Integer a)</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> a + b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// * Singleton: Can be initialized only once using getInstance()</span></span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Calculator uniqueInstance;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Calculator <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">      uniqueInstance = <span class="hljs-keyword">new</span> Calculator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> uniqueInstance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>차이를 아시겠나요? 하지만 <strong>유일한 클래스</strong>의 정적 변수, 메서드든 <strong>유일한 객체</strong>인 싱글턴 패턴이든 진입점이 한 곳인 만큼 다중 스레드가 한번에 진입점에 들어올 때 서로를 어떻게 독립적으로 수행할 수 있게 보장할지가 문제가 됩니다. 이를 유식한 말로는 다수의 스레드가 모두 이 클래스 내지는 객체에 접근을 하려 경쟁한다는 의미로 <strong>Race Condition(경쟁 상태)</strong>라고 합니다.</p>
<h1 id="Race-Condition"><a href="#Race-Condition" class="headerlink" title="Race Condition"></a>Race Condition</h1><p>Java 에서 다중 스레드를 사용할지라도 <strong>JVM 메모리에서는 따로 스레드별로 영역들을 지정해주지 않기 때문에 프로그래머가 접근제어를 해주지 않는다면 하나의 클래스 혹은 객체를 두 스레드에서 접근할 수 있습니다.</strong> Java 의 객체, 변수, 메서드 모두 기본적으로 non-blocking 이므로 여러 스레드에서 하나의 클래스 혹은 객체 접근을 동시에 할 경우 함수, 변수를 중복 호출/사용하는 문제가 발생합니다. 이를 해결하기 위해 가장 단순하게 생각할 수 있는것은 <strong>함수 단위로 blocking</strong> 하는것입니다.</p>
<p>위 싱글턴 패턴의 예로 사용한 <strong>Caculator 클래스의 getInstance() 함수를 두 개의 스레드에서 동시에 진입했다고 가정</strong>합시다. 동시에 <code>if (uniqueInstance == null)</code> 구문에 진입했을때 <strong>어느 스레드도 그 다음 라인인 <code>new Caculator()</code> 를 수행하지 않았다고 가정한다면 두 스레드 모두 uniqueInstance 가 null 인것으로 판단</strong>할것입니다. 그리고 그 다음 라인에 두 스레드 각각 새 객체를 생성하게 되고, 이렇게 된다면 두 스레드는 하나의 객체 함수가 아닌 각자의 객체 함수를 보게됩니다. 단순 계산 객체라면 큰 영향은 없겠지만 만약 하나의 상태를 공유하려는 객체라면 두 스레드가 서로 다른 상태를 보고있는 끔찍한 상황이 연출됩니다.</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Thread1: getInstance() </span><br><span class="line">  <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;         <span class="hljs-comment">// 2019-03-03 00:00:01</span></span><br><span class="line">    uniqueInstance = <span class="hljs-keyword">new</span> Calculator();  <span class="hljs-comment">// 2019-03-03 00:00:03 - Calculator 객체 1 생성 (Thread1)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Thread2: getInstance() </span><br><span class="line">  <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;         <span class="hljs-comment">// 2019-03-03 00:00:02</span></span><br><span class="line">    uniqueInstance = <span class="hljs-keyword">new</span> Calculator();  <span class="hljs-comment">// 2019-03-03 00:00:04 - Calculator 객체 2 생성 (Thread2)</span></span><br></pre></td></tr></table></figure>
<h2 id="함수-단위-Blocking-Synchronized"><a href="#함수-단위-Blocking-Synchronized" class="headerlink" title="함수 단위 Blocking - Synchronized"></a>함수 단위 Blocking - Synchronized</h2><p>다수의 스레드가 한 함수에 접근하려 한다면, 하나의 스레드가 해당 함수를 수행하는 동안에는 기다리도록 blocking 합니다. Java 가 제공하는 <strong>synchronized</strong> 키워드를 사용하면 손쉽게 해당 함수 호출을 blocking 할 수 있습니다. 이젠 Thread 1 이 해당 함수를 호출하고 끝날때까지 Thread 2 는 해당 함수 호출을 계속 기다려야합니다. 두 스레드가 한 함수를 동시에 호출할일은 없어졌습니다.</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Calculator <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">      uniqueInstance = <span class="hljs-keyword">new</span> Calculator();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> uniqueInstance;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>하지만 싱글턴 함수가 위에 로직보다 더 복잡하고 수행시간이 길다면 다른 스레드들은 한 스레드가 해당 함수 호출을 완료하는 그 긴 시간동안 멈춰있어야하는 성능의 이슈가 있습니다. 이런 경우에는 함수 단위의 blocking 이 아니라 함수 내 blocking 해야하는 딱 <strong>그 변수만 집어서 blocking</strong> 하는게 좋겠지요.</p>
<h2 id="변수-생성-단위-Blocking-DCL-Double-Checked-Locking"><a href="#변수-생성-단위-Blocking-DCL-Double-Checked-Locking" class="headerlink" title="변수 생성 단위 Blocking - DCL (Double Checked Locking)"></a>변수 생성 단위 Blocking - DCL (Double Checked Locking)</h2><p>우리의 원래 목적은 “변수”의 스레드간 공유인데, 굳이 함수 단위의 blocking 을 해서 변수 외 나머지 로직 수행의 시간까지 손만 빨며 성능 이슈까지 발생시킬 이유는 없습니다. 똑똑한 프로그래머들의 고민 결과 <strong>“함수”가 아닌 “변수” 단위의 Blocking</strong> 을 고안해내었고 이를 <strong>DCL (Double Checked Locking)</strong>이라고 명명합니다. 왜 Double Checked 일까요? 아래 코드를 보시면 객체 생성 로직 진입 전과 진입 후 생성하기전에 한번 더 null 여부를 검사하기 때문인것으로 알 수 있습니다.</p>
<ul>
<li><p><strong>함수 단위 Blocking - 함수에 synchronized 추가</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Calculator uniqueInstance;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Calculator <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">    uniqueInstance = <span class="hljs-keyword">new</span> Calculator();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> uniqueInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>변수 생성 단위 Blocking - 변수에 volatile 추가, 함수 내 해당 변수에 synchronized 추가</strong></p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> Calculator uniqueInstance;</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Calculator <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">synchronized</span> (Calculator.class) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (uniqueInstance == <span class="hljs-keyword">null</span>) &#123;</span><br><span class="line">        uniqueInstance = <span class="hljs-keyword">new</span> Calculator();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> uniqueInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>기존 방식은 getInstance() <strong>함수에 synchronized</strong> 가 붙어있는 반면, 변수 생성 단위 Blocking 에서는 <strong>변수에 volatile</strong> 이 추가되었고, 해당 함수 내 아까 <strong>volatile 을 추가한 변수에 대해서 synchronized</strong> 붙여준걸 알 수 있습니다. 여기서 유념히 보셔야할것은 <strong>변수를 사용하는 부분</strong>이 아닌 <strong>변수를 생성하는 부분에 synchronized 를 붙여줬음</strong>을 꼭 기억하시기 바랍니다.</p>
<h3 id="DCL-Double-Checked-Locking-의-의미"><a href="#DCL-Double-Checked-Locking-의-의미" class="headerlink" title="DCL (Double Checked Locking) 의 의미"></a>DCL (Double Checked Locking) 의 의미</h3><p>모든 프로그램 및 스레드는 CPU 을 통해 연산들을 수행하고, 연산을 위한 변수값들은 “메인 메모리”로부터 CPU 바로 옆 “캐시”로 가져와 사용하게 됩니다. 만약 두 스레드가 각자 다른 CPU (멀티코어 환경) 에서 하나의 싱글턴 혹은 정적 변수를 공유하여 작동한다면 어떤 일이 발생할까요? </p>
<center><img src="/2019/03/02/singleton-pattern/race-condition.svg"></center>

<p>두 스레드가 공유하는 하나의 변수는 기본적으로 “메인 메모리”에 적재되어 있습니다. 각 스레드가 각 CPU 에서 값을 변경하는 경우 1) 먼저 메인 메모리로부터 캐시로 변수값을 가져오고, 2) CPU 가 해당 캐시의 값을 변경하고, 3) 캐시에 변경된 값을 메인 메모리에 작성(동기화)하는 과정을 거칩니다. 두 스레드가 동시에 변수의 값에 접근할 경우, 첫번째 스레드가 자신이 할당된 CPU 내 캐시의 변수값을 먼저 바꿨음에도 불구하고 아직 메인 메모리에 쓰지 않아 두번째 스레드는 변경된 값을 모른채 자신의 CPU 에서 독립적으로 값 변경을 수행하는 문제가 발생합니다. </p>
<p>그렇다고 다수 스레드가 하나의 CPU 에서 수행된다고 하더라도 아예 문제가 없는것은 아닙니다. JIT 컴파일러에 의해 어셈블리 레벨 코드 재배열(Reorder)이 발생하여 스레드 간 참조하는 변수값이 달라질 수 있기 때문입니다.</p>
<p>위에서 설명한 스레드간 변수 동기화 내지는 불일치 문제를 한 스레드의 값 업데이트를 다른 스레드에서는 볼 수 없다는 의미의 <strong>가시성(Visibility) 문제</strong>라고 일컫습니다. 볼 수 있다면 Visible 하다. 라고 표현합니다.</p>
<p>가시성 문제를 해결하기 위해 “캐시”와 “메인 메모리” 간 <strong>읽은(READ) 값이 일치하도록 강제하는 것이 volatile</strong> 키워드 입니다. 변수에 volatile 키워드를 추가하면 해당 변수는 CPU 에서 “캐시”의 값을 읽을때 동시에 “메인 메모리”의 값을 Read 함을 보장합니다. 한 스레드에서 값을 변경한다면 바로 메인 메모리에 적용되고 다른 스레드가 값을 읽을 때 최신의 값을 읽을 수 있습니다. </p>
<p>하지만 두 스레드가 같은 메인 메모리 값을 가져다가 변경할 경우는 여전히 문제입니다. 값을 쓰는것은 어쩔 수 없이 blocking 을 걸어두어야합니다. 한 스레드가 작성하고있다면 다른 스레드는 기다렸다가 앞 스레드가 작성을 마치면 바로 메인 메모리로부터 값을 읽어서 그 다음 쓰기를 진행하면 됩니다. 이를 위해 <strong>값을 변경(WRITE)할때는 해당 클래스에 blocking 을 거는 synchronized</strong> 키워드를 함께 사용하면 됩니다. </p>
<h2 id="변수-사용-단위-Blocking-Lazy-Holder"><a href="#변수-사용-단위-Blocking-Lazy-Holder" class="headerlink" title="변수 사용 단위 Blocking - Lazy Holder"></a>변수 사용 단위 Blocking - Lazy Holder</h2><p>애석하게도 변수 생성 단위의 Blocking 으로 단일 생성이 완벽히 보장되진 않았습니다. 세상에, CPU 캐시까지 고려했는데 무엇을 또 놓쳤다는걸까요? 트랜지스터 레벨이라도 봐야하는 것일까요? <strong>DCL 을 통해 변수의 단일 생성 자체는 보장</strong>되었습니다. 다만 <strong>단일 생성 바로 직후</strong>에 다른 스레드에서 해당 변수를 바로 사용하려 한다면, 아직 채 완전히 생성되지 못한 변수를 사용하게 될 수 있다는 것입니다. 단일 생성을 시작하면 해당 클래스의 new ..를 통해 생성자를 수행하게 될 것입니다. 생성자가 조금이라도 복잡하다면 온전한 객체가 만들어지기 까지는 조금의 시간이 걸릴 것입니다. 하지만 해당 객체를 접근하는 다른 스레드는 그 라인의 끝마침을 기다려주지 않습니다. 이때 미처 다 온전하게 생성되지 않은 불완전한 객체를 다른 스레드에서 가져다가 사용하게 되는것입니다. 이를 <strong>out-of-order write 문제</strong>라고 명명합니다.</p>
<p>해결은 해당 객체가 <strong>단순히 생성되었다</strong> 여부가 아닌 <strong>완벽히 생성되었다</strong>는걸 보장하면 됩니다. 이를 보장하는 방식은 더 똑똑한 프로그래머들에 의해 정말 다양하게 제시되었는데요. 기발한것들도 있지만 그 중에 가장 이해가 쉬운것은 아래와 같습니다.</p>
<figure class="highlight java hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Calculator</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyHolder</span> </span>&#123;</span><br><span class="line">      <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Calculator UNIQUE_INSTANCE = <span class="hljs-keyword">new</span> Calculator();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Calculator <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;</span><br><span class="line">      <span class="hljs-keyword">return</span> LazyHolder.UNIQUE_INSTANCE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>static final 로 정의된 <code>UNIQUE_INSTANCE</code>는 클래스로더에 의해 프로그램 시작 시 가장 먼저 Static 영역에 바로 적재됩니다. 이를 통해 getInstance() 호출되기 이전에 UNIQUE_INSTANCE = new Calculator(); 가 무조건 존재함을 보장합니다.</li>
</ul>
<p>사실상 위에서 배운 모든 것을 활용한 해결책에 해당합니다. 개인적으로 이 해결책이 기억에 남는 이유가 C# 에서 LazyHolder 형식을 기본적으로 제공해주기 때문에 싱글턴 패턴 사용이 아래와 같이 매우 쉽게 해결했던 기억이 있습니다.</p>
<figure class="highlight csharp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> Lazy&lt;Singleton&gt; lazy = <span class="hljs-keyword">new</span> Lazy&lt;Singleton&gt;(() =&gt; <span class="hljs-keyword">new</span> Singleton());  </span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance &#123; <span class="hljs-keyword">get</span> &#123; <span class="hljs-keyword">return</span> lazy.Value; &#125; &#125;</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>(<span class="hljs-params"></span>)</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<ol>
<li><a href="https://gampol.tistory.com/entry/Double-checked-locking%EA%B3%BC-Singleton-%ED%8C%A8%ED%84%B4" target="_blank" rel="noopener">https://gampol.tistory.com/entry/Double-checked-locking%EA%B3%BC-Singleton-%ED%8C%A8%ED%84%B4</a></li>
<li><a href="http://thswave.github.io/java/2015/03/08/java-volatile.html" target="_blank" rel="noopener">http://thswave.github.io/java/2015/03/08/java-volatile.html</a></li>
</ol>

        </div>
        
        
        
    </div>
</div>










</div>
                
                    




<div class="column is-3-tablet is-3-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                Categories
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Design-Pattern/">
            <span class="level-start">
                <span class="level-item">Design Pattern</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">6</span>
            </span>
        </a><ul><li>
        <a class="level is-marginless" href="/categories/Design-Pattern/Adapter-Decorator/">
            <span class="level-start">
                <span class="level-item">Adapter, Decorator</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Design-Pattern/Factory/">
            <span class="level-start">
                <span class="level-item">Factory</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Design-Pattern/Observer/">
            <span class="level-start">
                <span class="level-item">Observer</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Design-Pattern/Singleton/">
            <span class="level-start">
                <span class="level-item">Singleton</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li></ul></li><li>
        <a class="level is-marginless" href="/categories/Workplace/">
            <span class="level-start">
                <span class="level-item">Workplace</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">1</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar.png" alt="Aaron Ryu">
                    
                    
                    <p class="is-size-4 is-block">
                        Aaron Ryu
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Software Developer
                    </p>
                    
                    
                </div>
            </div>
        </nav>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Github" href="https://github.com/aaronryu">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="Gitlab" href="https://gitlab.com/aaronryu">
                
                <i class="fab fa-gitlab"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank" title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Posts
                    </p>
                    <p class="title has-text-weight-normal">
                        7
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        Categories
                    </p>
                    <p class="title has-text-weight-normal">
                        6
                    </p>
                </div>
            </div>
        </nav>
        
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            Recent
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-03-02T12:15:18.000Z">2019-03-02</time></div>
                    <a href="/2019/03/02/singleton-pattern/" class="has-link-black-ter is-size-6">6. 싱글턴 패턴</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Design-Pattern/">Design Pattern</a> / <a class="has-link-grey -link" href="/categories/Design-Pattern/Singleton/">Singleton</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-27T13:23:42.000Z">2019-02-27</time></div>
                    <a href="/2019/02/27/observer-pattern/" class="has-link-black-ter is-size-6">5. 옵저버 패턴</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Design-Pattern/">Design Pattern</a> / <a class="has-link-grey -link" href="/categories/Design-Pattern/Observer/">Observer</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-02-26T17:59:41.000Z">2019-02-27</time></div>
                    <a href="/2019/02/27/adapter-decorator-facade-pattern/" class="has-link-black-ter is-size-6">4. 데코레이터, 어댑터, 퍼사드 패턴</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Design-Pattern/">Design Pattern</a> / <a class="has-link-grey -link" href="/categories/Design-Pattern/Adapter-Decorator/">Adapter, Decorator</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

    
        


    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                    
                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    Crucian Carp
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Aaron Ryu&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("en");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="Back to Top" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>